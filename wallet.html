<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Ø¨ÙŠØªÙƒÙˆÙŠÙ† ÙƒØ§Ø´ - Ù…Ø­ÙØ¸ØªÙŠ</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header>
    <h1>ğŸ’¼ Ù…Ø­ÙØ¸ØªÙŠ</h1>
    <p>Ù‡Ù†Ø§ ØªØ±Ù‰ Ø±ØµÙŠØ¯Ùƒ Ø¨Ø§Ù„Ù†Ù‚Ø§Ø· ÙˆØ§Ù„Ø¯ÙˆÙ„Ø§Ø±ØŒ ÙˆØªÙ‚Ø¯Ù… Ø·Ù„Ø¨Ø§Øª Ø³Ø­Ø¨.</p>
  </header>

  <main>
    <section class="card">
      <h2>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ</h2>
      <p id="balance-text">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
    </section>

    <section class="card">
      <h2>Ø·Ù„Ø¨ Ø³Ø­Ø¨</h2>
      <form id="withdraw-form">
        <label>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ (Ø¯ÙˆÙ„Ø§Ø±)</label>
        <input type="number" id="amount" min="1" required />
        <label>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø­ÙØ¸Ø© (BTC)</label>
        <input type="text" id="wallet-address" required />
        <button type="submit" class="primary">Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨</button>
      </form>
      <p class="hint">Ø§Ù„Ø³Ø­Ø¨ ÙŠØ¯ÙˆÙŠ ÙˆÙŠØªÙ… Ø®Ù„Ø§Ù„ 20 ÙŠÙˆÙ… ÙƒØ­Ø¯ Ø£Ø¯Ù†Ù‰ Ø¨Ø¹Ø¯ Ø§Ù„Ø´Ø­Ù†.</p>
      <p id="withdraw-status" class="status"></p>
    </section>

    <section class="card">
      <h2>Ø¥Ø«Ø¨Ø§ØªØ§Øª Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ù…Ø±Ø³Ù„Ø©</h2>
      <div id="payments-list">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
    </section>
  </main>

  <nav class="bottom-nav">
    <a href="profile.html">ğŸ‘¤ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</a>
    <a href="ads.html">ğŸ“º Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª</a>
    <a href="wallet.html" class="active">ğŸ’¼ Ù…Ø­ÙØ¸ØªÙŠ</a>
    <a href="about.html">â„¹ï¸ Ù…Ù† Ù†Ø­Ù†</a>
  </nav>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="supabase.js"></script>
  <script>
    const balanceText = document.getElementById('balance-text');
    const withdrawForm = document.getElementById('withdraw-form');
    const withdrawStatus = document.getElementById('withdraw-status');
    const paymentsList = document.getElementById('payments-list');

    async function loadBalance() {
      const user = await getCurrentUser();
      if (!user) {
        balanceText.textContent = 'Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ù† Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©.';
        return;
      }

      const { data, error } = await supabase
        .from('users_data')
        .select('points, balance_usd')
        .eq('id', user.id)
        .single();

      if (error) {
        balanceText.textContent = 'Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø±ØµÙŠØ¯: ' + error.message;
      } else {
        const pts = data.points ?? 0;
        const usd = data.balance_usd ?? 0;
        balanceText.textContent = `Ø§Ù„Ù†Ù‚Ø§Ø·: ${pts} Ù†Ù‚Ø·Ø©  |  Ø§Ù„Ø±ØµÙŠØ¯ Ø¨Ø§Ù„Ø¯ÙˆÙ„Ø§Ø±: $${usd}`;
      }
    }

    async function loadPayments() {
      const user = await getCurrentUser();
      if (!user) {
        paymentsList.textContent = 'Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.';
        return;
      }

      const { data, error } = await supabase
        .from('payments')
        .select('*')
        .eq('user_id', user.id)
        .order('id', { ascending: false });

      if (error) {
        paymentsList.textContent = 'Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø¥Ø«Ø¨Ø§ØªØ§Øª Ø§Ù„Ø¯ÙØ¹: ' + error.message;
        return;
      }

      if (!data || data.length === 0) {
        paymentsList.textContent = 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¥Ø«Ø¨Ø§ØªØ§Øª Ø¨Ø¹Ø¯.';
        return;
      }

      paymentsList.innerHTML = '';
      data.forEach(p => {
        const div = document.createElement('div');
        div.className = 'mini';
        div.innerHTML = `
          <p>Ù…Ø¨Ù„Øº: $${p.amount}</p>
          ${p.image_url ? `<img src="${p.image_url}" alt="Ø¥Ø«Ø¨Ø§Øª" />` : ''}
          <p class="date">${new Date(p.created_at).toLocaleString('ar-SY')}</p>
        `;
        paymentsList.appendChild(div);
      });
    }

    withdrawForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      withdrawStatus.textContent = 'Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨...';

      const user = await getCurrentUser();
      if (!user) {
        withdrawStatus.textContent = 'ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.';
        return;
      }

      const amount = Number(document.getElementById('amount').value);
      const wallet = document.getElementById('wallet-address').value.trim();

      const { data, error } = await supabase.from('withdrawals').insert({
        user_id: user.id,
        amount,
        wallet_address: wallet,
      });

      if (error) {
        withdrawStatus.textContent = 'Ø®Ø·Ø£: ' + error.message;
      } else {
        withdrawStatus.textContent = 'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨ âœ…';
        withdrawForm.reset();
      }
    });

    loadBalance();
    loadPayments();
  </script>
</body>
</html>
