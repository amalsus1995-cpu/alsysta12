<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Ø¨ÙŠØªÙƒÙˆÙŠÙ† ÙƒØ§Ø´ - Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header>
    <h1>ğŸ“º Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©</h1>
    <p>Ø´Ø§Ù‡Ø¯ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ù„ØªØ­ØµÙ„ Ø¹Ù„Ù‰ Ù†Ù‚Ø§Ø· Ø«Ù… ØªØªØ­ÙˆÙ„ Ø¥Ù„Ù‰ Ø¯ÙˆÙ„Ø§Ø± ÙÙŠ Ù…Ø­ÙØ¸ØªÙƒ.</p>
  </header>

  <main>
    <section id="ads-list">
      <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª...</p>
    </section>
    <p id="ads-status" class="status"></p>
  </main>

  <nav class="bottom-nav">
    <a href="profile.html">ğŸ‘¤ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</a>
    <a href="ads.html" class="active">ğŸ“º Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª</a>
    <a href="wallet.html">ğŸ’¼ Ù…Ø­ÙØ¸ØªÙŠ</a>
    <a href="about.html">â„¹ï¸ Ù…Ù† Ù†Ø­Ù†</a>
  </nav>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="supabase.js"></script>
  <script>
    const adsContainer = document.getElementById('ads-list');
    const statusEl = document.getElementById('ads-status');

    async function loadAds() {
      const user = await getCurrentUser();
      if (!user) {
        statusEl.textContent = 'Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ù† Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹.';
        adsContainer.innerHTML = '';
        return;
      }

      const { data, error } = await supabase.from('ads').select('*').order('id');
      if (error) {
        statusEl.textContent = 'Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª: ' + error.message;
        return;
      }
      if (!data || data.length === 0) {
        adsContainer.innerHTML = '<p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹.</p>';
        return;
      }

      adsContainer.innerHTML = '';
      data.forEach(ad => {
        const box = document.createElement('div');
        box.className = 'card';

        box.innerHTML = `
          <h3>Ø¥Ø¹Ù„Ø§Ù† Ø±Ù‚Ù… ${ad.id}</h3>
          <video width="100%" controls src="${ad.video_url}"></video>
          <button class="primary watch-btn" data-ad-id="${ad.id}">âœ… Ø´Ø§Ù‡Ø¯Øª Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†</button>
        `;
        adsContainer.appendChild(box);
      });

      document.querySelectorAll('.watch-btn').forEach(btn => {
        btn.addEventListener('click', () => handleWatched(btn.dataset.adId));
      });
    }

    async function handleWatched(adId) {
      statusEl.textContent = 'Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø©...';

      const user = await getCurrentUser();
      if (!user) {
        statusEl.textContent = 'ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹.';
        return;
      }

      // ØªØ³Ø¬ÙŠÙ„ ÙÙŠ Ø¬Ø¯ÙˆÙ„ views_log
      const { data, error } = await supabase.from('views_log').insert({
        user_id: user.id,
        ad_id: adId,
      });

      if (error) {
        statusEl.textContent = 'Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø©: ' + error.message;
      } else {
        statusEl.textContent = 'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø© âœ…. Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù†Ù‚Ø§Ø· Ø¥Ù„Ù‰ Ø­Ø³Ø§Ø¨Ùƒ.';
      }
    }

    loadAds();
  </script>
</body>
</html>
